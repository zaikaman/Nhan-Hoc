<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug IndexedDB</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      color: #fff;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .section {
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    button {
      background: #00FFE0;
      color: #151627;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }
    button:hover {
      background: #00d4b8;
    }
    pre {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .success { color: #00FFE0; }
    .error { color: #FF3D00; }
    .warning { color: #FFA500; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Debug IndexedDB - Learning Platform</h1>
    
    <div class="section">
      <h2>üìä Actions</h2>
      <button onclick="checkDB()">Ki·ªÉm tra Database</button>
      <button onclick="viewActivities()">Xem Learning Activities</button>
      <button onclick="viewQuizResults()">Xem Quiz Results</button>
      <button onclick="addTestData()">Th√™m Test Data</button>
      <button onclick="clearData()">X√≥a All Data</button>
    </div>

    <div class="section">
      <h2>üìã Results</h2>
      <pre id="output">Nh·∫•n m·ªôt button ƒë·ªÉ b·∫Øt ƒë·∫ßu...</pre>
    </div>
  </div>

  <script>
    const DB_NAME = 'LearningPlatformDB';
    const DB_VERSION = 5;
    const LEARNING_ACTIVITIES_STORE = 'learningActivities';
    const QUIZ_RESULTS_STORE = 'quizResults';

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
      output.innerHTML += `<span class="${color}">[${timestamp}] ${message}</span>\n`;
    }

    function clearOutput() {
      document.getElementById('output').innerHTML = '';
    }

    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // Create stores if they don't exist
          if (!db.objectStoreNames.contains(LEARNING_ACTIVITIES_STORE)) {
            const store = db.createObjectStore(LEARNING_ACTIVITIES_STORE, { keyPath: 'id', autoIncrement: true });
            store.createIndex('timestamp', 'timestamp', { unique: false });
            store.createIndex('topic', 'topic', { unique: false });
            store.createIndex('activityType', 'activityType', { unique: false });
          }
          
          if (!db.objectStoreNames.contains(QUIZ_RESULTS_STORE)) {
            const store = db.createObjectStore(QUIZ_RESULTS_STORE, { keyPath: 'id', autoIncrement: true });
            store.createIndex('timestamp', 'timestamp', { unique: false });
            store.createIndex('topic', 'topic', { unique: false });
            store.createIndex('score', 'score', { unique: false });
          }
        };
      });
    }

    async function checkDB() {
      clearOutput();
      log('üîç ƒêang ki·ªÉm tra IndexedDB...', 'info');
      
      try {
        const db = await openDB();
        log(`‚úÖ Database: ${db.name} (version ${db.version})`, 'success');
        
        const storeNames = Array.from(db.objectStoreNames);
        log(`üì¶ Object Stores: ${storeNames.join(', ')}`, 'info');
        
        if (storeNames.includes(LEARNING_ACTIVITIES_STORE)) {
          log(`‚úÖ Store "${LEARNING_ACTIVITIES_STORE}" t·ªìn t·∫°i`, 'success');
        } else {
          log(`‚ùå Store "${LEARNING_ACTIVITIES_STORE}" KH√îNG t·ªìn t·∫°i`, 'error');
        }
        
        if (storeNames.includes(QUIZ_RESULTS_STORE)) {
          log(`‚úÖ Store "${QUIZ_RESULTS_STORE}" t·ªìn t·∫°i`, 'success');
        } else {
          log(`‚ùå Store "${QUIZ_RESULTS_STORE}" KH√îNG t·ªìn t·∫°i`, 'error');
        }
        
        db.close();
      } catch (error) {
        log(`‚ùå L·ªói: ${error.message}`, 'error');
      }
    }

    async function viewActivities() {
      clearOutput();
      log('üìö ƒêang l·∫•y Learning Activities...', 'info');
      
      try {
        const db = await openDB();
        const transaction = db.transaction([LEARNING_ACTIVITIES_STORE], 'readonly');
        const store = transaction.objectStore(LEARNING_ACTIVITIES_STORE);
        const request = store.getAll();
        
        request.onsuccess = () => {
          const activities = request.result;
          log(`‚úÖ T√¨m th·∫•y ${activities.length} activities`, 'success');
          
          if (activities.length > 0) {
            activities.forEach((activity, index) => {
              log(`\n--- Activity ${index + 1} ---`, 'info');
              log(JSON.stringify(activity, null, 2), 'info');
            });
          } else {
            log('‚ö†Ô∏è Ch∆∞a c√≥ activities n√†o ƒë∆∞·ª£c l∆∞u', 'warning');
          }
          
          db.close();
        };
        
        request.onerror = () => {
          log(`‚ùå L·ªói: ${request.error}`, 'error');
          db.close();
        };
      } catch (error) {
        log(`‚ùå L·ªói: ${error.message}`, 'error');
      }
    }

    async function viewQuizResults() {
      clearOutput();
      log('üéØ ƒêang l·∫•y Quiz Results...', 'info');
      
      try {
        const db = await openDB();
        const transaction = db.transaction([QUIZ_RESULTS_STORE], 'readonly');
        const store = transaction.objectStore(QUIZ_RESULTS_STORE);
        const request = store.getAll();
        
        request.onsuccess = () => {
          const results = request.result;
          log(`‚úÖ T√¨m th·∫•y ${results.length} quiz results`, 'success');
          
          if (results.length > 0) {
            results.forEach((result, index) => {
              log(`\n--- Quiz Result ${index + 1} ---`, 'info');
              log(JSON.stringify(result, null, 2), 'info');
            });
          } else {
            log('‚ö†Ô∏è Ch∆∞a c√≥ quiz results n√†o ƒë∆∞·ª£c l∆∞u', 'warning');
          }
          
          db.close();
        };
        
        request.onerror = () => {
          log(`‚ùå L·ªói: ${request.error}`, 'error');
          db.close();
        };
      } catch (error) {
        log(`‚ùå L·ªói: ${error.message}`, 'error');
      }
    }

    async function addTestData() {
      clearOutput();
      log('‚ûï ƒêang th√™m test data...', 'info');
      
      try {
        const db = await openDB();
        
        // Add test activity
        const activityTransaction = db.transaction([LEARNING_ACTIVITIES_STORE], 'readwrite');
        const activityStore = activityTransaction.objectStore(LEARNING_ACTIVITIES_STORE);
        
        const testActivity = {
          topic: 'React',
          subtopic: 'Hooks',
          activityType: 'view_resource',
          duration: 300,
          timestamp: new Date().toISOString(),
          date: new Date().toISOString().split('T')[0]
        };
        
        activityStore.add(testActivity);
        
        // Add test quiz result
        const quizTransaction = db.transaction([QUIZ_RESULTS_STORE], 'readwrite');
        const quizStore = quizTransaction.objectStore(QUIZ_RESULTS_STORE);
        
        const testQuiz = {
          topic: 'React',
          subtopic: 'useState',
          score: 85,
          totalQuestions: 10,
          correctAnswers: 8.5,
          timeSpent: 120,
          passed: true,
          timestamp: new Date().toISOString(),
          date: new Date().toISOString().split('T')[0]
        };
        
        quizStore.add(testQuiz);
        
        log('‚úÖ ƒê√£ th√™m test data!', 'success');
        log('Test Activity:', 'info');
        log(JSON.stringify(testActivity, null, 2), 'info');
        log('\nTest Quiz Result:', 'info');
        log(JSON.stringify(testQuiz, null, 2), 'info');
        
        db.close();
      } catch (error) {
        log(`‚ùå L·ªói: ${error.message}`, 'error');
      }
    }

    async function clearData() {
      if (!confirm('‚ö†Ô∏è X√≥a T·∫§T C·∫¢ d·ªØ li·ªáu analytics? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
        return;
      }
      
      clearOutput();
      log('üóëÔ∏è ƒêang x√≥a d·ªØ li·ªáu...', 'info');
      
      try {
        const db = await openDB();
        
        // Clear activities
        const activityTransaction = db.transaction([LEARNING_ACTIVITIES_STORE], 'readwrite');
        const activityStore = activityTransaction.objectStore(LEARNING_ACTIVITIES_STORE);
        activityStore.clear();
        
        // Clear quiz results
        const quizTransaction = db.transaction([QUIZ_RESULTS_STORE], 'readwrite');
        const quizStore = quizTransaction.objectStore(QUIZ_RESULTS_STORE);
        quizStore.clear();
        
        log('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu!', 'success');
        
        db.close();
      } catch (error) {
        log(`‚ùå L·ªói: ${error.message}`, 'error');
      }
    }

    // Auto check on load
    window.onload = () => {
      log('üöÄ Debug tool ƒë√£ s·∫µn s√†ng!', 'success');
      log('Nh·∫•n "Ki·ªÉm tra Database" ƒë·ªÉ b·∫Øt ƒë·∫ßu\n', 'info');
    };
  </script>
</body>
</html>
